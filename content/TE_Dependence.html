
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BOLD, non-BOLD, and TE-dependence with tedana &#8212; Multi-Echo fMRI Data Analysis</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../_static/myfile.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Generate tedana walkthrough figures" href="plot_approach_figures.html" />
    <link rel="prev" title="Signal Decay" href="Signal_Decay.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Multi-Echo fMRI Data Analysis</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Multi-Echo (fMRI) Data Analysis
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Course Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Course_Overview.html">
   Course Overview
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_Download_Data.html">
   Download Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Install_Software.html">
   Install Software
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Recommended_Reading.html">
   Recommended Reading
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Theoretical Background
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="MR_Physics.html">
   MR Physics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fMRI_Sequences.html">
   Multi-Echo fMRI Sequences
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Signal_Decay.html">
   Signal Decay
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   BOLD, non-BOLD, and TE-dependence with tedana
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="plot_approach_figures.html">
   Generate tedana walkthrough figures
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Practical Resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Multi_Echo_Datasets.html">
   Open Multi-Echo Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Acquiring_Multi_Echo_Data.html">
   Acquiring Multi-Echo Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Processing_Multi_Echo_Data.html">
   Processing Multi-Echo Data
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Analysis Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_Optimal_Combination_with_t2smap.html">
   Optimal combination with
   <code class="docutils literal notranslate">
    <span class="pre">
     t2smap
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_Volume-wise_T2star_estimation_with_t2smap.html">
   Volume-wise T2*/S0 estimation with
   <code class="docutils literal notranslate">
    <span class="pre">
     t2smap
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_Denoising_with_tedana.html">
   Multi-Echo Denoising with
   <code class="docutils literal notranslate">
    <span class="pre">
     tedana
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_Dual_Echo_Denoising.html">
   Dual-Echo Denoising with
   <code class="docutils literal notranslate">
    <span class="pre">
     nilearn
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_3dMEPFM.html">
   3dMEPFM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_Cerebrovascular_Reactivity_Mapping.html">
   Cerebrovascular Reactivity Mapping
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_Manual_Classification_with_rica.html">
   Manual Classification with
   <code class="docutils literal notranslate">
    <span class="pre">
     rica
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_ICA_Based_Denoising.html">
   Denoising Data with ICA
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Final Thoughts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="bibliography.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="build_information.html">
   Build Information
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="glossary.html">
   Glossary
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/content/TE_Dependence.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/content/TE_Dependence.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ME-ICA/multi-echo-data-analysis"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ME-ICA/multi-echo-data-analysis/issues/new?title=Issue%20on%20page%20%2Fcontent/TE_Dependence.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ME-ICA/multi-echo-data-analysis/main?urlpath=tree/content/content/TE_Dependence.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-simulations-of-bold-and-non-bold-signals-as-a-function-of-echo-time">
   Plot simulations of BOLD and non-BOLD signals as a function of echo time
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-design-matrices">
   Make design matrices
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#te-independence-model">
   TE-independence model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#te-dependence-model">
   TE-dependence model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitted-curves-for-s0-perturbed-signal">
   Fitted curves for S0-perturbed signal
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitted-curves-for-r2-perturbed-signal">
   Fitted curves for R2*-perturbed signal
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#now-let-s-apply-this-approach-to-components">
   Now let’s apply this approach to components
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="bold-non-bold-and-te-dependence-with-tedana">
<h1>BOLD, non-BOLD, and TE-dependence with tedana<a class="headerlink" href="#bold-non-bold-and-te-dependence-with-tedana" title="Permalink to this headline">¶</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This chapter should differentiate itself from Signal_Decay by focusing on the application of <a class="reference internal" href="#equation-monoexponential-decay">(1)</a>
to decompositions, rather than raw signal compared between active and inactive states.</p>
<p>We may want to describe adaptive masking, data whitening, the model fit metrics, and post-processing methods (e.g., MIR)
in this page as well.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The general flow of this chapter should be:</p>
<ol class="simple">
<li><p>Explain the monoexponential decay equation, but primarily reference back to Signal_Decay.</p></li>
<li><p>Walk through optimal combination and adaptive masking somewhere around here.</p></li>
<li><p>Describe why multi-echo denoising can’t be done directly to the raw signal and why ICA is necessary.</p>
<ol class="simple">
<li><p>This mean talking about noise, really, and why the FIT method (volume-wise T2*/S0 estimation)
is generally considered too noisy for practical application.</p></li>
<li><p>Walk through TEDPCA as well.</p></li>
</ol>
</li>
<li><p>The TE-(in)dependence models.</p></li>
<li><p>Apply the models to a simulated component, as well as multiple real components.</p>
<ol class="simple">
<li><p>Show model fit for different components.</p></li>
</ol>
</li>
<li><p>Compare optimally combined, denoised, and high-kappa data.</p></li>
<li><p>Describe post-processing methods, like minimum image regression and tedana’s version of global signal regression.</p></li>
</ol>
</div>
<p>This notebook uses simulated T2*/S0 manipulations to show how TE-dependence is leveraged to denoise multi-echo data.</p>
<p>The equation for how signal is dependent on changes in S0 and T2*:</p>
<div class="math notranslate nohighlight" id="equation-monoexponential-decay">
<span class="eqno">(1)<a class="headerlink" href="#equation-monoexponential-decay" title="Permalink to this equation">¶</a></span>\[S(t, TE_k) = \bar{S}(TE_k) * (1 + \frac{{\Delta}{S_0}(t)}{\bar{S}_0} - {\Delta}{R_2^*}(t)*TE_k)\]</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">book_utils</span> <span class="kn">import</span> <span class="n">compute_te_dependence_statistics</span><span class="p">,</span> <span class="n">predict_bold_signal</span>
<span class="kn">from</span> <span class="nn">myst_nb</span> <span class="kn">import</span> <span class="n">glue</span>
<span class="kn">from</span> <span class="nn">nilearn.glm</span> <span class="kn">import</span> <span class="n">first_level</span>
<span class="kn">from</span> <span class="nn">repo2data.repo2data</span> <span class="kn">import</span> <span class="n">Repo2Data</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span><span class="p">,</span> <span class="n">stats</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>

<span class="c1"># Install the data if running locally, or point to cached data if running on neurolibre</span>
<span class="n">DATA_REQ_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;../binder/data_requirement.json&quot;</span><span class="p">)</span>

<span class="c1"># Download data</span>
<span class="n">repo2data</span> <span class="o">=</span> <span class="n">Repo2Data</span><span class="p">(</span><span class="n">DATA_REQ_FILE</span><span class="p">)</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">repo2data</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;data&quot;</span><span class="p">))</span>

<span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;te-dependence&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/nilearn/datasets/__init__.py:96: FutureWarning: Fetchers from the nilearn.datasets module will be updated in version 0.9 to return python strings instead of bytes and Pandas dataframes instead of Numpy arrays.
  &quot;Numpy arrays.&quot;, FutureWarning)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>---- repo2data starting ----
/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/repo2data
Config from file :
../binder/data_requirement.json
Destination:
./../data/multi-echo-data-analysis

Info : ./../data/multi-echo-data-analysis already downloaded
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/nilearn/glm/__init__.py:56: FutureWarning: The nilearn.glm module is experimental. It may change in any future release of Nilearn.
  &#39;It may change in any future release of Nilearn.&#39;, FutureWarning)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulate data</span>
<span class="c1"># For a nice, smooth curve</span>
<span class="n">echo_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">n_echoes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">echo_times</span><span class="p">)</span>
<span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;cubehelix&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="n">mean_s0</span> <span class="o">=</span> <span class="mi">16000</span>
<span class="n">mean_t2s</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">frac</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">s02</span> <span class="o">=</span> <span class="n">mean_s0</span> <span class="o">+</span> <span class="p">(</span><span class="n">mean_s0</span> <span class="o">*</span> <span class="n">frac</span><span class="p">)</span>
<span class="n">t2s2</span> <span class="o">=</span> <span class="n">mean_t2s</span> <span class="o">+</span> <span class="p">(</span><span class="n">mean_t2s</span> <span class="o">*</span> <span class="n">frac</span><span class="p">)</span>

<span class="n">mean_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predict_bold_signal</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">mean_s0</span><span class="p">,</span> <span class="n">mean_t2s</span><span class="p">))</span>

<span class="c1"># Signal with fluctuating S0</span>
<span class="n">sig2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predict_bold_signal</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">s02</span><span class="p">,</span> <span class="n">mean_t2s</span><span class="p">))</span>
<span class="n">d_sig2</span> <span class="o">=</span> <span class="n">sig2</span> <span class="o">-</span> <span class="n">mean_sig</span>
<span class="n">dt_sig2</span> <span class="o">=</span> <span class="n">d_sig2</span> <span class="o">/</span> <span class="p">((</span><span class="n">sig2</span> <span class="o">+</span> <span class="n">mean_sig</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="c1"># Signal with fluctuating T2*</span>
<span class="n">sig3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predict_bold_signal</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">mean_s0</span><span class="p">,</span> <span class="n">t2s2</span><span class="p">))</span>
<span class="n">d_sig3</span> <span class="o">=</span> <span class="n">sig3</span> <span class="o">-</span> <span class="n">mean_sig</span>
<span class="n">dt_sig3</span> <span class="o">=</span> <span class="n">d_sig3</span> <span class="o">/</span> <span class="p">((</span><span class="n">sig3</span> <span class="o">+</span> <span class="n">mean_sig</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="plot-simulations-of-bold-and-non-bold-signals-as-a-function-of-echo-time">
<h2>Plot simulations of BOLD and non-BOLD signals as a function of echo time<a class="headerlink" href="#plot-simulations-of-bold-and-non-bold-signals-as-a-function-of-echo-time" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># change s0</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">mean_sig</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean signal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">sig2</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Timepoint&#39;s signal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Change in S0&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
    <span class="s2">&quot;Signal</span><span class="se">\n</span><span class="s2">$S(TE_n)$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
<span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">d_sig2</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
    <span class="s2">&quot;${</span><span class="se">\\</span><span class="s2">Delta}S(TE_n)$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
<span class="p">)</span>

<span class="c1"># No slope, intercept at delta(S0)/mean(S0)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">dt_sig2</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
    <span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">frac{{</span><span class="se">\\</span><span class="s2">Delta}S(TE_n)}{</span><span class="se">\\</span><span class="s2">bar</span><span class="si">{S}</span><span class="s2">(TE_n)}$&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">labelpad</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Echo Time (ms)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># change t2s</span>
<span class="c1"># max diff is between orig and new T2*, but is definitely not mean</span>
<span class="n">max_diff_te</span> <span class="o">=</span> <span class="n">echo_times</span><span class="p">[</span><span class="n">d_sig3</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d_sig3</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">mean_sig</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean signal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">sig3</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Timepoint&#39;s signal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Change in T2*&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>

<span class="c1"># Plot important echo times</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_t2s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">max_diff_te</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t2s2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">d_sig3</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Plot important echo times</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_t2s</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;T2* of mean data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">max_diff_te</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;TE of maximized contrast&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t2s2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;T2* of timepoint&#39;s data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">pred_slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_sig3</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt_sig3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">echo_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">echo_times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">pred_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_slope</span> <span class="o">*</span> <span class="n">echo_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">dt_sig3</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">pred_max</span> <span class="o">=</span> <span class="n">pred_slope</span> <span class="o">*</span> <span class="n">echo_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">dt_sig3</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">echo_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
    <span class="p">[</span><span class="n">pred_int</span><span class="p">,</span> <span class="n">pred_max</span><span class="p">],</span>
    <span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Theoretical line&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">echo_times</span><span class="p">))</span>
<span class="c1"># axes[2, 1].set_xticks(echo_times)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Echo Time (ms)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">max_diff_te</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_t2s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t2s2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fig_bold_nonbold_simulations&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_4_1.png" src="../_images/TE_Dependence_4_1.png" />
</div>
</div>
<div class="figure align-center" id="fig-bold-nonbold-simulations">
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_4_0.png" src="../_images/TE_Dependence_4_0.png" />
</div>
<p class="caption"><span class="caption-number">Fig. 14 </span><span class="caption-text">Simulations of BOLD and non-BOLD signals as a function of echo time</span><a class="headerlink" href="#fig-bold-nonbold-simulations" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="make-design-matrices">
<h2>Make design matrices<a class="headerlink" href="#make-design-matrices" title="Permalink to this headline">¶</a></h2>
<p>For TEDPCA and TEDICA, we use regression to get parameter estimates (PEs; not beta values)
for component time-series against echo-specific data, and substitute those PEs for <span class="math notranslate nohighlight">\({\bar{S}(TE_k)}\)</span>.
At some point, I would like to dig into why those parameter estimates are equivalent to <span class="math notranslate nohighlight">\({\bar{S}(TE_k)}\)</span> for our purposes.</p>
</div>
<div class="section" id="te-independence-model">
<h2>TE-independence model<a class="headerlink" href="#te-independence-model" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight" id="equation-te-independence-model1">
<span class="eqno">(2)<a class="headerlink" href="#equation-te-independence-model1" title="Permalink to this equation">¶</a></span>\[\frac{{\Delta}S(TE_k)}{\bar{S(TE_k)}} = \frac{{\Delta}S_0}{S_0}\]</div>
<div class="math notranslate nohighlight" id="equation-te-independence-model2">
<span class="eqno">(3)<a class="headerlink" href="#equation-te-independence-model2" title="Permalink to this equation">¶</a></span>\[{\Delta}S(TE_k) = {\bar{S}(TE_k)}\frac{{\Delta}S_0}{S_0}\]</div>
<p><span class="math notranslate nohighlight">\(\frac{{\Delta}S_0}{S_0}\)</span> is a scalar (i.e., doesn’t change with TE), so we ignore that,
which means we only use <span class="math notranslate nohighlight">\({\bar{S}(TE_k)}\)</span> (mean echo-wise signal).</p>
<p>Thus,</p>
<div class="math notranslate nohighlight" id="equation-te-independence-model3">
<span class="eqno">(4)<a class="headerlink" href="#equation-te-independence-model3" title="Permalink to this equation">¶</a></span>\[{\Delta}S(TE_k) = {\bar{S}(TE_k)} * X\]</div>
<p>and for TEDPCA/TEDICA,</p>
<div class="math notranslate nohighlight" id="equation-te-independence-model4">
<span class="eqno">(5)<a class="headerlink" href="#equation-te-independence-model4" title="Permalink to this equation">¶</a></span>\[PE(TE_k) = {\bar{S}(TE_k)} * X\]</div>
<p>Lastly, we fit X to the data and evaluate model fit.</p>
</div>
<div class="section" id="te-dependence-model">
<h2>TE-dependence model<a class="headerlink" href="#te-dependence-model" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight" id="equation-te-dependence-model1">
<span class="eqno">(6)<a class="headerlink" href="#equation-te-dependence-model1" title="Permalink to this equation">¶</a></span>\[\frac{{\Delta}S(TE_k)}{\bar{S}(TE_k)} = -{\Delta}{R_2^*}*TE_k\]</div>
<div class="math notranslate nohighlight" id="equation-te-dependence-model2">
<span class="eqno">(7)<a class="headerlink" href="#equation-te-dependence-model2" title="Permalink to this equation">¶</a></span>\[{\Delta}S(TE_k) = {\bar{S}(TE_k)} * -{\Delta}{R_2^*}*TE_k\]</div>
<p><span class="math notranslate nohighlight">\(-{\Delta}{R_2^*}\)</span> is a scalar, so we ignore it,
which means we only use <span class="math notranslate nohighlight">\({\bar{S}(TE_k)}\)</span> (mean echo-wise-signal) and <span class="math notranslate nohighlight">\(TE_k\)</span> (echo time in milliseconds).</p>
<p>Thus,</p>
<div class="math notranslate nohighlight" id="equation-te-dependence-model3">
<span class="eqno">(8)<a class="headerlink" href="#equation-te-dependence-model3" title="Permalink to this equation">¶</a></span>\[{\Delta}S(TE_k) = {\bar{S}(TE_k)}*TE_k * X\]</div>
<p>and for TEDPCA/TEDICA,</p>
<div class="math notranslate nohighlight" id="equation-te-dependence-model4">
<span class="eqno">(9)<a class="headerlink" href="#equation-te-dependence-model4" title="Permalink to this equation">¶</a></span>\[PE(TE_k) = {\bar{S}(TE_k)}*TE_k * X\]</div>
<p>Lastly, we fit X to the data and evaluate model fit.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X1</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_sig</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># Model 1</span>

<span class="c1"># NOTE: T2* is unnecessary for this, since it&#39;s a scalar</span>
<span class="n">X2</span> <span class="o">=</span> <span class="p">((</span><span class="n">echo_times</span> <span class="o">*</span> <span class="n">mean_sig</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_t2s</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># Model 2</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fitted-curves-for-s0-perturbed-signal">
<h2>Fitted curves for S0-perturbed signal<a class="headerlink" href="#fitted-curves-for-s0-perturbed-signal" title="Permalink to this headline">¶</a></h2>
<p>The predicted curve for the S0 model matches the real curve perfectly!</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B</span> <span class="o">=</span> <span class="n">d_sig2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (E x S)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># S0 Model</span>
<span class="n">coeffs_S0</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">X1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">X1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pred_S0</span> <span class="o">=</span> <span class="n">X1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">coeffs_S0</span><span class="p">,</span> <span class="p">(</span><span class="n">n_echoes</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">SSE_S0</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">pred_S0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">SSE_S0</span> <span class="o">=</span> <span class="n">SSE_S0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (S,) prediction error map</span>
<span class="n">F_S0</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">SSE_S0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_echoes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">SSE_S0</span><span class="p">)</span>
<span class="n">pred_S0_2</span> <span class="o">=</span> <span class="n">pred_S0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># R2 Model</span>
<span class="n">coeffs_R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">X2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">X2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pred_R2</span> <span class="o">=</span> <span class="n">X2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">coeffs_R2</span><span class="p">,</span> <span class="p">(</span><span class="n">n_echoes</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">SSE_R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">pred_R2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">SSE_R2</span> <span class="o">=</span> <span class="n">SSE_R2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">F_R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">SSE_R2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_echoes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">SSE_R2</span><span class="p">)</span>
<span class="n">pred_R2_2</span> <span class="o">=</span> <span class="n">pred_R2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rho: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">F_S0</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kappa: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">F_R2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Parameter estimate * mean S0 gives delta(S0)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real delta S0: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s02</span> <span class="o">-</span> <span class="n">mean_s0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Delta S0 from results: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coeffs_S0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mean_s0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rho: 4.467769094175043e+32
Kappa: 187.14447409804956

Real delta S0: 3200.0
Delta S0 from results: 3200.000000000006
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fitted-curves-for-r2-perturbed-signal">
<h2>Fitted curves for R2*-perturbed signal<a class="headerlink" href="#fitted-curves-for-r2-perturbed-signal" title="Permalink to this headline">¶</a></h2>
<p>For some reason, the predicted curve for the R2 model doesn’t match the real signal curve.
What’s with this mismatch?</p>
<p>It seems like the mismatch increases as the difference between the fluctuating volume’s R2 and the mean R2 increase.
The fitted curve seems to actually match the mean signal, not the perturbed signal!</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B</span> <span class="o">=</span> <span class="n">d_sig3</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (E x S)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># S0 Model</span>
<span class="n">coeffs_S0</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">X1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">X1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pred_S0</span> <span class="o">=</span> <span class="n">X1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">coeffs_S0</span><span class="p">,</span> <span class="p">(</span><span class="n">n_echoes</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">SSE_S0</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">pred_S0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">SSE_S0</span> <span class="o">=</span> <span class="n">SSE_S0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (S,) prediction error map</span>
<span class="n">F_S0</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">SSE_S0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_echoes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">SSE_S0</span><span class="p">)</span>
<span class="n">pred_S0_3</span> <span class="o">=</span> <span class="n">pred_S0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># R2 Model</span>
<span class="n">coeffs_R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">X2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">X2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pred_R2</span> <span class="o">=</span> <span class="n">X2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">coeffs_R2</span><span class="p">,</span> <span class="p">(</span><span class="n">n_echoes</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">SSE_R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">pred_R2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">SSE_R2</span> <span class="o">=</span> <span class="n">SSE_R2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">F_R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">SSE_R2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_echoes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">SSE_R2</span><span class="p">)</span>
<span class="n">pred_R2_3</span> <span class="o">=</span> <span class="n">pred_R2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rho: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">F_S0</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kappa: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">F_R2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rho: 156.88794104788448
Kappa: 31513.966302911744
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Change in S0&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">d_sig2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;${</span><span class="se">\\</span><span class="s2">Delta}S(TE_k)$&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">echo_times</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_R2_2</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted signal for R2* model&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">echo_times</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_S0_2</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted signal for S0 model&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">echo_times</span><span class="p">))</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Change in T2*&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">d_sig3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;${</span><span class="se">\\</span><span class="s2">Delta}S(TE_k)$&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">echo_times</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_R2_3</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted signal for R2* model&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">echo_times</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_S0_3</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted signal for S0 model&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">echo_times</span><span class="p">))</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fig_fitted_r2_curves&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_11_1.png" src="../_images/TE_Dependence_11_1.png" />
</div>
</div>
<div class="figure align-center" id="fig-fitted-r2-curves">
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_11_0.png" src="../_images/TE_Dependence_11_0.png" />
</div>
<p class="caption"><span class="caption-number">Fig. 15 </span><span class="caption-text">Fitted curves for R2*-perturbed signal</span><a class="headerlink" href="#fig-fitted-r2-curves" title="Permalink to this image">¶</a></p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lstsq gives same result as model fit method by kundu, which is great to see</span>
<span class="n">x</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">sing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coeffs_R2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.19006077]
[0.19006077]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="now-let-s-apply-this-approach-to-components">
<h2>Now let’s apply this approach to components<a class="headerlink" href="#now-let-s-apply-this-approach-to-components" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulate data</span>
<span class="c1"># We&#39;ll convolve with HRF just for smoothness</span>
<span class="n">hrf</span> <span class="o">=</span> <span class="n">first_level</span><span class="o">.</span><span class="n">spm_hrf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">oversampling</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">n_trs</span> <span class="o">=</span> <span class="mi">300</span>

<span class="n">frac</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 5% PSC</span>
<span class="n">mean_t2s</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">t2s_std</span> <span class="o">=</span> <span class="n">mean_t2s</span> <span class="o">*</span> <span class="n">frac</span>
<span class="n">mean_s0</span> <span class="o">=</span> <span class="mi">16000</span>
<span class="n">s0_std</span> <span class="o">=</span> <span class="n">mean_s0</span> <span class="o">*</span> <span class="n">frac</span>

<span class="c1"># simulate the T2*/S0 time series</span>
<span class="n">t2s_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mean_t2s</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">t2s_std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_trs</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,))</span>
<span class="n">t2s_ts</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">t2s_ts</span><span class="p">,</span> <span class="n">hrf</span><span class="p">)[</span><span class="mi">20</span> <span class="p">:</span> <span class="n">n_trs</span> <span class="o">+</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">t2s_ts</span> <span class="o">*=</span> <span class="n">t2s_std</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t2s_ts</span><span class="p">)</span>
<span class="n">t2s_ts</span> <span class="o">+=</span> <span class="n">mean_t2s</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t2s_ts</span><span class="p">)</span>

<span class="n">s0_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mean_s0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">s0_std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_trs</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,))</span>
<span class="n">s0_ts</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">s0_ts</span><span class="p">,</span> <span class="n">hrf</span><span class="p">)[</span><span class="mi">20</span> <span class="p">:</span> <span class="n">n_trs</span> <span class="o">+</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">s0_ts</span> <span class="o">*=</span> <span class="n">s0_std</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">s0_ts</span><span class="p">)</span>
<span class="n">s0_ts</span> <span class="o">+=</span> <span class="n">mean_s0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s0_ts</span><span class="p">)</span>

<span class="c1"># Constant T2*/S0 time series</span>
<span class="n">mean_s0_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_trs</span><span class="p">)</span> <span class="o">*</span> <span class="n">mean_s0</span>
<span class="n">mean_t2s_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_trs</span><span class="p">)</span> <span class="o">*</span> <span class="n">mean_t2s</span>

<span class="c1"># Simulate signal for each echo time</span>
<span class="n">t2s_signal</span> <span class="o">=</span> <span class="n">predict_bold_signal</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">mean_s0_ts</span><span class="p">,</span> <span class="n">t2s_ts</span><span class="p">)</span>
<span class="n">s0_signal</span> <span class="o">=</span> <span class="n">predict_bold_signal</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">s0_ts</span><span class="p">,</span> <span class="n">mean_t2s_ts</span><span class="p">)</span>
<span class="n">multiecho_signal</span> <span class="o">=</span> <span class="n">predict_bold_signal</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">s0_ts</span><span class="p">,</span> <span class="n">t2s_ts</span><span class="p">)</span>

<span class="c1"># Normalize to get component time series</span>
<span class="n">t2s_ts_z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">t2s_ts</span><span class="p">)</span>
<span class="n">s0_ts_z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">s0_ts</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># proportion for combination</span>
<span class="n">component</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">t2s_ts_z</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">s0_ts_z</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2s_ts_z</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;T2* fluctuations&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s0_ts_z</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;S0 fluctuations&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Component&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_trs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (TR)&quot;</span><span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fig_component_curves&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_15_1.png" src="../_images/TE_Dependence_15_1.png" />
</div>
</div>
<div class="figure align-center" id="fig-component-curves">
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_15_0.png" src="../_images/TE_Dependence_15_0.png" />
</div>
<p class="caption"><span class="caption-number">Fig. 16 </span><span class="caption-text">Now let’s apply this approach to components</span><a class="headerlink" href="#fig-component-curves" title="Permalink to this image">¶</a></p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n_echoes</span> <span class="o">/</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">echoes_to_plot</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_echoes</span><span class="p">,</span> <span class="n">interval</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">echoes_to_plot</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i_echo</span><span class="p">,</span> <span class="n">echo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">echoes_to_plot</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i_echo</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">multiecho_signal</span><span class="p">[</span><span class="n">echo</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="n">pal</span><span class="p">[</span><span class="n">i_echo</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i_echo</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">ms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">echo_times</span><span class="p">[</span><span class="n">echo</span><span class="p">]),</span>
        <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i_echo</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i_echo</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_trs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fig_component_curves_2&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_17_1.png" src="../_images/TE_Dependence_17_1.png" />
</div>
</div>
<div class="figure align-center" id="fig-component-curves-2">
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_17_0.png" src="../_images/TE_Dependence_17_0.png" />
</div>
<p class="caption"><span class="caption-number">Fig. 17 </span><span class="caption-text">Now let’s apply this approach to components again.</span><a class="headerlink" href="#fig-component-curves-2" title="Permalink to this image">¶</a></p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n_echoes</span> <span class="o">/</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">echoes_to_plot</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_echoes</span><span class="p">,</span> <span class="n">interval</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i_echo</span><span class="p">,</span> <span class="n">echo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">echoes_to_plot</span><span class="p">):</span>
    <span class="n">rep_echo_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_trs</span><span class="p">)</span> <span class="o">*</span> <span class="n">echo</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rep_echo_times</span><span class="p">,</span> <span class="n">multiecho_signal</span><span class="p">[</span><span class="n">echo</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">pal</span><span class="p">[</span><span class="n">i_echo</span><span class="p">])</span>

<span class="n">max_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">multiecho_signal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">min_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">multiecho_signal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">max_signal</span><span class="p">,</span> <span class="n">min_signal</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;BOLD signal&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Echo Time (ms)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">echoes_to_plot</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">echo_times</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fig_component_curves_3&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_19_1.png" src="../_images/TE_Dependence_19_1.png" />
</div>
</div>
<div class="figure align-center" id="fig-component-curves-3">
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_19_0.png" src="../_images/TE_Dependence_19_0.png" />
</div>
<p class="caption"><span class="caption-number">Fig. 18 </span><span class="caption-text">Now let’s apply this approach to components again.</span><a class="headerlink" href="#fig-component-curves-3" title="Permalink to this image">¶</a></p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Add a constant term to the array</span>
<span class="n">comp_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">component</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">component</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>
<span class="n">pes</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">comp_X</span><span class="p">,</span> <span class="n">multiecho_signal</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">pes</span> <span class="o">=</span> <span class="n">pes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">F_S0</span><span class="p">,</span> <span class="n">F_R2</span><span class="p">,</span> <span class="n">pred_S0</span><span class="p">,</span> <span class="n">pred_R2</span> <span class="o">=</span> <span class="n">compute_te_dependence_statistics</span><span class="p">(</span>
    <span class="n">multiecho_signal</span><span class="p">,</span> <span class="n">pes</span><span class="p">,</span> <span class="n">echo_times</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">pred_R2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted T2* model values&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">pred_S0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted S0 model values&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">pes</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Component PEs&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">pred_R2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\kappa$ = </span><span class="si">{:.02f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">F_R2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">echo_times</span><span class="p">,</span> <span class="n">pred_S0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\rho$ = </span><span class="si">{:.02f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">F_S0</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">echo_times</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Echo time (ms)&quot;</span><span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fig_component_curves_4&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_21_1.png" src="../_images/TE_Dependence_21_1.png" />
</div>
</div>
<div class="figure align-center" id="fig-component-curves-4">
<div class="cell_output docutils container">
<img alt="../_images/TE_Dependence_21_0.png" src="../_images/TE_Dependence_21_0.png" />
</div>
<p class="caption"><span class="caption-number">Fig. 19 </span><span class="caption-text">Now let’s apply this approach to components again.</span><a class="headerlink" href="#fig-component-curves-4" title="Permalink to this image">¶</a></p>
</div>
<div class="proof algorithm admonition" id="minimum-image-regression">
<p class="admonition-title"><span class="caption-number">Algorithm 1 </span> (Minimum image regression)</p>
<div class="algorithm-content section" id="proof-content">
<!-- Written by Taylor Salo, Jessica Bartley, and Elizabeth DuPre -->
<p><strong>Inputs</strong></p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mathbf{O}\)</span> is the matrix of optimally combined (OC) data, of shape <span class="math notranslate nohighlight">\(v \times t\)</span>,
where <span class="math notranslate nohighlight">\(v\)</span> is the number of voxels in the brain mask and <span class="math notranslate nohighlight">\(t\)</span> is the number of timepoints in the scan.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{M}\)</span> is the mixing matrix from the ICA decomposition, of shape <span class="math notranslate nohighlight">\(c \times t\)</span>, where <span class="math notranslate nohighlight">\(c\)</span> is the number of components.</p></li>
<li><p><span class="math notranslate nohighlight">\(W\)</span> is the set of indices of all components in <span class="math notranslate nohighlight">\(\mathbf{M}\)</span>: <span class="math notranslate nohighlight">\(W = \{1, 2, 3, ..., c\}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(N\)</span> is the set of indices of all non-ignored components (i.e., all accepted or BOLD-like, and rejected or non-BOLD components) in
<span class="math notranslate nohighlight">\(\mathbf{M}\)</span>: <span class="math notranslate nohighlight">\(N \in \mathbb{N}^k \text{ s.t } 1 \leq k \leq c, N \subseteq W\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(A\)</span> is the set of indices of all accepted (i.e., BOLD-like) components in <span class="math notranslate nohighlight">\(\mathbf{M}\)</span>:
<span class="math notranslate nohighlight">\(A \in \mathbb{N}^l \text{ s.t } 1 \leq l \leq k, A \subseteq N\)</span></p></li>
</ul>
<p><strong>Outputs</strong></p>
<ul class="simple">
<li><p>Multi-echo denoised data without the T1-like effect, referred to as <span class="math notranslate nohighlight">\(\mathbf{D}\)</span> or MEDN+MIR.</p></li>
<li><p>Multi-echo BOLD-like data without the T1-like effect, referred to as <span class="math notranslate nohighlight">\(\mathbf{H}\)</span> or MEHK+MIR.</p></li>
<li><p>ICA mixing matrix with the T1-like effect removed from component time series (<span class="math notranslate nohighlight">\(\mathbf{K}\)</span>).</p></li>
<li><p>Map of the T1-like effect (<span class="math notranslate nohighlight">\(\mathbf{m}\)</span>)</p></li>
</ul>
<p><strong>Algorithm</strong></p>
<ol>
<li><p>The voxel-wise means (<span class="math notranslate nohighlight">\(\mathbf{\overline{O}} \in \mathbb{R}^{v}\)</span>) and standard deviations
(<span class="math notranslate nohighlight">\(\mathbf{\sigma_{O}} \in \mathbb{R}^{v}\)</span>) of the optimally combined data are computed over time.</p></li>
<li><p>The optimally combined data are z-normalized over time (<span class="math notranslate nohighlight">\(\mathbf{O_z} \in \mathbb{R}^{v \times t}\)</span>).</p></li>
<li><p>The normalized optimally combined data matrix (<span class="math notranslate nohighlight">\(\mathbf{O_z}\)</span>) is regressed on the ICA mixing matrix
(<span class="math notranslate nohighlight">\(\mathbf{M} \in \mathbb{R}^{c \times t}\)</span>) to construct component-wise parameter estimate maps
(<span class="math notranslate nohighlight">\(\mathbf{B} \in \mathbb{R}^{v \times c}\)</span>).</p>
<!-- no intercept included, because unnecessary and data are normalized. -->
<div class="math notranslate nohighlight">
\[
        \mathbf{O_{z}} = \mathbf{B} \mathbf{M} + \mathbf{\epsilon}, \enspace \mathbf{\epsilon} \in \mathbb{R}^{v \times t}
    \]</div>
</li>
<li><p><span class="math notranslate nohighlight">\(N\)</span> is used to select rows from the mixing matrix <span class="math notranslate nohighlight">\(\mathbf{M}\)</span> and columns from the parameter estimate matrix <span class="math notranslate nohighlight">\(\mathbf{B}\)</span>
that correspond to non-ignored (i.e., accepted and rejected) components, forming reduced matrices <span class="math notranslate nohighlight">\(\mathbf{M}_N\)</span> and <span class="math notranslate nohighlight">\(\mathbf{B}_N\)</span>.
The normalized time series matrix for the combined ignored components and variance left unexplained by the ICA decomposition is then
computed by subtracting the scalar product of the non-ignored beta weight and mixing matrices from the normalized OC data time series
(<span class="math notranslate nohighlight">\(\mathbf{O_{z}}\)</span>).
The result is referred to as the normalized residuals time series matrix (<span class="math notranslate nohighlight">\(\mathbf{R} \in \mathbb{R}^{v \times t}\)</span>).</p>
<div class="math notranslate nohighlight">
\[
        \mathbf{R} = \mathbf{O_{z}} - \mathbf{B}_N \mathbf{M}_N, \enspace \mathbf{B}_N \in \mathbb{R}^{v \times |N|},
        \enspace \mathbf{M}_N \in \mathbb{R}^{|N| \times t}
    \]</div>
</li>
<li><p>We can likewise construct the normalized time series of BOLD-like components (<span class="math notranslate nohighlight">\(\mathbf{P} \in \mathbb{R}^{v \times t}\)</span>) by
multiplying similarly reduced parameter estimate and mixing matrices composed of only the columns and rows, respectively,
that are associated with the accepted components indexed in <span class="math notranslate nohighlight">\(A\)</span>.
The resulting time series matrix is similar to the time series matrix referred to elsewhere in the manuscript as
multi-echo high-Kappa (MEHK), with the exception that the component time series have been normalized prior to reconstruction.</p>
<div class="math notranslate nohighlight">
\[
        \mathbf{P} = \mathbf{B}_A \mathbf{M}_A, \enspace \mathbf{B}_A \in \mathbb{R}^{v \times |A|},
        \enspace \mathbf{M}_A \in \mathbb{R}^{|A| \times t}
    \]</div>
</li>
<li><p>The map of the T1-like effect (<span class="math notranslate nohighlight">\(\mathbf{m} \in \mathbb{R}^{v}\)</span>) is constructed by taking the minimum across timepoints
from the normalized MEHK time series (<span class="math notranslate nohighlight">\(\mathbf{P}\)</span>) and then mean-centering across brain voxels.
Let <span class="math notranslate nohighlight">\(J = \{1, ..., t\}\)</span> denote the indices of the columns of matrix <span class="math notranslate nohighlight">\(\mathbf{P}\)</span>, and let <span class="math notranslate nohighlight">\(p_{ij}\)</span> denote the value of the
element <span class="math notranslate nohighlight">\(\mathbf{P}[i,j]\)</span>.</p>
<!-- adapted from https://math.stackexchange.com/a/871689 -->
<div class="math notranslate nohighlight">
\[
        \mathbf{q_{i}} = \min_{j\in{J}}p_{ij} \quad \forall  i = 1,...,v
    \]</div>
<div class="math notranslate nohighlight">
\[
        \mathbf{m} = \mathbf{q} - \mathbf{\overline{q}}, \enspace \mathbf{q} \in \mathbb{R}^{v}
    \]</div>
</li>
<li><p>The standardized optimally combined time series matrix (<span class="math notranslate nohighlight">\(\mathbf{O_z}\)</span>) is regressed on the T1-like effect map
(<span class="math notranslate nohighlight">\(\mathbf{m}\)</span>) to estimate the volume-wise global signal time series (<span class="math notranslate nohighlight">\(\mathbf{g} \in \mathbb{R}^t\)</span>).</p>
<div class="math notranslate nohighlight">
\[
        \mathbf{O_{z}} = \mathbf{m} \otimes \mathbf{g} + \mathbf{\epsilon}, \enspace \mathbf{\epsilon} \in \mathbb{R}^{v \times t}
    \]</div>
<p>Where <span class="math notranslate nohighlight">\(\otimes\)</span> is the outer product.</p>
</li>
<li><p>The normalized BOLD time series matrix (<span class="math notranslate nohighlight">\(\mathbf{P}\)</span>) is then regressed on this global signal time series (<span class="math notranslate nohighlight">\(\mathbf{g}\)</span>)
in order to estimate a global signal map (<span class="math notranslate nohighlight">\(\mathbf{s} \in \mathbb{R}^v\)</span>) and the normalized BOLD time series matrix without
the T1-like effect (<span class="math notranslate nohighlight">\(\mathbf{E} \in \mathbb{R}^{v \times t}\)</span>).</p>
<div class="math notranslate nohighlight">
\[
        \mathbf{P} = \mathbf{g} \otimes \mathbf{s} + \mathbf{E}
    \]</div>
</li>
<li><p>The time series matrix of BOLD-like components without the T1-like effect (MEHK+MIR, <span class="math notranslate nohighlight">\(\mathbf{H} \in \mathbb{R}^{v \times t}\)</span>),
scaled to match the original OC time series matrix, is constructed by multiplying each column of <span class="math notranslate nohighlight">\(\mathbf{E}\)</span> by the vector
<span class="math notranslate nohighlight">\(\mathbf{\sigma_{O}}\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
        \mathbf{H} = \mathbf{E} \circ
        \underbrace{
            \pmatrix{
                \mathbf{{\sigma_{O}}_1} &amp; \cdots &amp; \mathbf{{\sigma_{O}}_1}\\
                \vdots &amp; \vdots &amp; \vdots \\
                \mathbf{{\sigma_{O}}_v} &amp; \cdots &amp; \mathbf{{\sigma_{O}}_v}\\
            }
        }_{t}
    \end{split}\]</div>
<p>Where <span class="math notranslate nohighlight">\(\circ\)</span> is the <a class="reference external" href="https://en.wikipedia.org/wiki/Hadamard_product_(matrices)">Hadamard product</a>
for element-wise multiplication of two matrices.</p>
</li>
<li><p>The ICA-denoised time series without the T1-like effect (MEDN+MIR, <span class="math notranslate nohighlight">\(\mathbf{D} \in \mathbb{R}^{v \times t}\)</span>)
is constructed by adding the residuals time series (<span class="math notranslate nohighlight">\(\mathbf{R}\)</span>) to the normalized BOLD time series (<span class="math notranslate nohighlight">\(\mathbf{E}\)</span>),
multiplying each column of the result by the vector <span class="math notranslate nohighlight">\(\sigma_{O}\)</span>, and adding back in the voxel-wise mean of the OC time series
(<span class="math notranslate nohighlight">\(\mathbf{\overline{O}}\)</span>).</p>
<div class="math notranslate nohighlight">
\[\begin{split}
        \mathbf{D} = \mathbf{\overline{O}} + (\mathbf{E} + \mathbf{R}) \circ
        \underbrace{
            \pmatrix{
                \mathbf{{\sigma_{O}}_1} &amp; \cdots &amp; \mathbf{{\sigma_{O}}_1}\\
                \vdots &amp; \vdots &amp; \vdots \\
                \mathbf{{\sigma_{O}}_v} &amp; \cdots &amp; \mathbf{{\sigma_{O}}_v}\\
            }
        }_{t}
    \end{split}\]</div>
</li>
<li><p>The T1c-corrected ICA mixing matrix is then derived by regressing the global signal time series <span class="math notranslate nohighlight">\(\mathbf{g}\)</span> from
each component’s time series. Let <span class="math notranslate nohighlight">\(\mathbf{Q}\)</span> be the associated parameter estimate matrix
(<span class="math notranslate nohighlight">\(\mathbf{Q} \in \mathbb{R}^{c \times t}\)</span>).</p>
<div class="math notranslate nohighlight">
\[
        \mathbf{M} = \mathbf{Q}\mathbf{g} + \mathbf{K}
    \]</div>
<div class="math notranslate nohighlight">
\[
        \mathbf{K} = \mathbf{M} - \mathbf{Q}\mathbf{g}
    \]</div>
</li>
</ol>
</div>
</div></div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="Signal_Decay.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Signal Decay</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_approach_figures.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Generate tedana walkthrough figures</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The tedana community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>