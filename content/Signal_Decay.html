
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signal Decay &#8212; Multi-Echo fMRI Data Analysis</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../_static/myfile.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BOLD, non-BOLD, and TE-dependence with tedana" href="TE_Dependence.html" />
    <link rel="prev" title="Multi-Echo fMRI Sequences" href="fMRI_Sequences.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Multi-Echo fMRI Data Analysis</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Multi-Echo (fMRI) Data Analysis
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Course Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Course_Overview.html">
   Course Overview
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_Download_Data.html">
   Download Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Install_Software.html">
   Install Software
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Recommended_Reading.html">
   Recommended Reading
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Theoretical Background
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="MR_Physics.html">
   MR Physics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fMRI_Sequences.html">
   Multi-Echo fMRI Sequences
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Signal Decay
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="TE_Dependence.html">
   BOLD, non-BOLD, and TE-dependence with tedana
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="plot_approach_figures.html">
   Generate tedana walkthrough figures
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Practical Resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Multi_Echo_Datasets.html">
   Open Multi-Echo Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Acquiring_Multi_Echo_Data.html">
   Acquiring Multi-Echo Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Processing_Multi_Echo_Data.html">
   Processing Multi-Echo Data
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Analysis Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_Optimal_Combination_with_t2smap.html">
   Optimal combination with
   <code class="docutils literal notranslate">
    <span class="pre">
     t2smap
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_Volume-wise_T2star_estimation_with_t2smap.html">
   Volume-wise T2*/S0 estimation with
   <code class="docutils literal notranslate">
    <span class="pre">
     t2smap
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_Denoising_with_tedana.html">
   Multi-Echo Denoising with
   <code class="docutils literal notranslate">
    <span class="pre">
     tedana
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_Dual_Echo_Denoising.html">
   Dual-Echo Denoising with
   <code class="docutils literal notranslate">
    <span class="pre">
     nilearn
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_3dMEPFM.html">
   Model-free deconvolution with
   <code class="docutils literal notranslate">
    <span class="pre">
     pySPFM
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_Cerebrovascular_Reactivity_Mapping.html">
   Cerebrovascular Reactivity Mapping
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_Manual_Classification_with_rica.html">
   Manual Classification with
   <code class="docutils literal notranslate">
    <span class="pre">
     rica
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_ICA_Based_Denoising.html">
   Denoising Data with ICA
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Final Thoughts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="bibliography.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="build_information.html">
   Build Information
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="glossary.html">
   Glossary
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/ME-ICA/multi-echo-data-analysis/main?urlpath=tree/content/content/Signal_Decay.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ME-ICA/multi-echo-data-analysis"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ME-ICA/multi-echo-data-analysis/issues/new?title=Issue%20on%20page%20%2Fcontent/Signal_Decay.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/content/Signal_Decay.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="../_sources/content/Signal_Decay.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#signal-decays-as-echo-time-increases">
   Signal decays as echo time increases
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#echo-specific-data-and-echo-time">
     Echo-specific data and echo time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-signal-itself-changes-with-echo-time-as-well">
     The signal itself changes with echo time as well
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-impact-of-t-2-and-s-0-fluctuations-on-bold-signal">
   The impact of
   <span class="math notranslate nohighlight">
    \(T_{2}^{*}\)
   </span>
   and
   <span class="math notranslate nohighlight">
    \(S_{0}\)
   </span>
   fluctuations on BOLD signal
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulate-t-2-and-s-0-fluctuations">
     Simulate
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     fluctuations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-bold-signal-decay-for-a-standard-single-echo-scan">
       Plot BOLD signal decay for a standard single-echo scan
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-bold-signal-decay-and-bold-contrast">
     Plot BOLD signal decay and BOLD contrast
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-single-echo-data-resulting-from-s-0-and-t-2-fluctuations">
     Plot single-echo data resulting from
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-single-echo-data-and-the-curve-resulting-from-s-0-and-t-2-fluctuations">
     Plot single-echo data and the curve resulting from
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-single-echo-data-the-curve-and-the-s-0-and-t-2-values-resulting-from-s-0-and-t-2-fluctuations">
     Plot single-echo data, the curve, and the
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     values resulting from
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-s-0-and-t-2-fluctuations">
     Plot
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-s-0-and-t-2-fluctuations-and-resulting-single-echo-data">
     Plot
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations and resulting single-echo data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-s-0-and-t-2-fluctuations-and-resulting-multi-echo-data">
     Plot
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations and resulting multi-echo data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-t-2-against-bold-signal-from-single-echo-data-te-30ms">
       Plot
       <span class="math notranslate nohighlight">
        \(T_{2}^{*}\)
       </span>
       against BOLD signal from single-echo data (TE=30ms)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-s-0-against-bold-signal-from-single-echo-data-te-30ms">
       Plot
       <span class="math notranslate nohighlight">
        \(S_{0}\)
       </span>
       against BOLD signal from single-echo data (TE=30ms)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Signal Decay</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#signal-decays-as-echo-time-increases">
   Signal decays as echo time increases
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#echo-specific-data-and-echo-time">
     Echo-specific data and echo time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-signal-itself-changes-with-echo-time-as-well">
     The signal itself changes with echo time as well
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-impact-of-t-2-and-s-0-fluctuations-on-bold-signal">
   The impact of
   <span class="math notranslate nohighlight">
    \(T_{2}^{*}\)
   </span>
   and
   <span class="math notranslate nohighlight">
    \(S_{0}\)
   </span>
   fluctuations on BOLD signal
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulate-t-2-and-s-0-fluctuations">
     Simulate
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     fluctuations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-bold-signal-decay-for-a-standard-single-echo-scan">
       Plot BOLD signal decay for a standard single-echo scan
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-bold-signal-decay-and-bold-contrast">
     Plot BOLD signal decay and BOLD contrast
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-single-echo-data-resulting-from-s-0-and-t-2-fluctuations">
     Plot single-echo data resulting from
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-single-echo-data-and-the-curve-resulting-from-s-0-and-t-2-fluctuations">
     Plot single-echo data and the curve resulting from
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-single-echo-data-the-curve-and-the-s-0-and-t-2-values-resulting-from-s-0-and-t-2-fluctuations">
     Plot single-echo data, the curve, and the
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     values resulting from
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-s-0-and-t-2-fluctuations">
     Plot
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-s-0-and-t-2-fluctuations-and-resulting-single-echo-data">
     Plot
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations and resulting single-echo data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-s-0-and-t-2-fluctuations-and-resulting-multi-echo-data">
     Plot
     <span class="math notranslate nohighlight">
      \(S_{0}\)
     </span>
     and
     <span class="math notranslate nohighlight">
      \(T_{2}^{*}\)
     </span>
     fluctuations and resulting multi-echo data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-t-2-against-bold-signal-from-single-echo-data-te-30ms">
       Plot
       <span class="math notranslate nohighlight">
        \(T_{2}^{*}\)
       </span>
       against BOLD signal from single-echo data (TE=30ms)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-s-0-against-bold-signal-from-single-echo-data-te-30ms">
       Plot
       <span class="math notranslate nohighlight">
        \(S_{0}\)
       </span>
       against BOLD signal from single-echo data (TE=30ms)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="signal-decay">
<h1>Signal Decay<a class="headerlink" href="#signal-decay" title="Permalink to this headline">#</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This chapter should differentiate itself from TE_Dependence by focusing on the application of <a class="reference internal" href="TE_Dependence.html#equation-monoexponential-decay">(1)</a>
to raw signal, rather than decompositions.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The general flow of this chapter should be:</p>
<ol class="simple">
<li><p>Explain the monoexponential decay equation.</p>
<ol class="simple">
<li><p>Mention other models of signal decay, including biexponential models,
and why they generally aren’t used on multi-echo fMRI data.</p></li>
</ol>
</li>
<li><p>Show signal decay in real data.</p>
<ol class="simple">
<li><p>Start with single-volume brain images across increasing echo times.</p></li>
<li><p>Next, show a scatter plot of the values for a single voxel over time, separated by echo time,
to give a better sense of the scale of the decay.</p></li>
<li><p>Line plots of the different echo times for a single voxel to show that decay is not a simple scalar.</p></li>
</ol>
</li>
<li><p>Show a simulated, static decay curve.</p></li>
<li><p>Show the difference in decay curves for “active” and “inactive” states in the same voxel (i.e., different T2* values).</p></li>
<li><p>Show how single-echo data fluctuate over time, given an underlying signal.</p></li>
<li><p>Add a changing decay curve underneath the single-echo data point.</p></li>
<li><p>Overlay points for the changing T2* and S0 values as well.</p></li>
<li><p>Plot the decay curves of the same relative fluctuations, but dependent solely on S0 or T2* changes.</p></li>
<li><p>Overlay single-echo data points on the fluctuating decay curves,
to show how the two types of fluctuations cannot be dissociated using single-echo data.</p>
<ol class="simple">
<li><p>Plot scaled T2* against the single-echo data in a line plot. The time series will be very similar, but slightly different.</p></li>
<li><p>Plot scaled S0 against the single-echo data. The time series will effectively be the same.</p></li>
<li><p>Point out that we don’t know the underlying T2* or S0 fluctuations,
so this just shows how very similar signal can come from T2* <em>or</em> S0.</p></li>
</ol>
</li>
<li><p>Overlay multi-echo data points on the fluctuating decay curves, to show how the differences in the patterns are much clearer.</p></li>
<li><p>Discuss the effect of noise on the multi-echo signal. Perhaps plot a single voxel’s real values?</p></li>
<li><p>Point to the TE Dependence chapter.</p></li>
</ol>
</div>
<p>In this chapter, we illustrate how BOLD signal decays and how we can glean useful information from that decay rate.</p>
<p>To do this, we will use a combination of simulated and real multi-echo data.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os

import matplotlib.pyplot as plt
import nibabel as nib
import numpy as np
import pandas as pd
import seaborn as sns
from IPython import display
from matplotlib.animation import FuncAnimation
from myst_nb import glue
from nilearn import image, masking, plotting
from nilearn.glm import first_level
from repo2data.repo2data import Repo2Data
from scipy import signal

from book_utils import predict_bold_signal

sns.set_style(&quot;whitegrid&quot;)

# Install the data if running locally, or point to cached data if running on neurolibre
DATA_REQ_FILE = os.path.join(&quot;../binder/data_requirement.json&quot;)

# Download data
repo2data = Repo2Data(DATA_REQ_FILE)
data_path = repo2data.install()
data_path = os.path.abspath(os.path.join(data_path[0], &quot;data&quot;))

out_dir = os.path.join(data_path, &quot;signal-decay&quot;)
os.makedirs(out_dir, exist_ok=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>---- repo2data starting ----
/opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages/repo2data
Config from file :
../binder/data_requirement.json
Destination:
./../data/multi-echo-data-analysis

Info : ./../data/multi-echo-data-analysis already downloaded
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>func_dir = os.path.join(data_path, &quot;sub-04570/func/&quot;)
data_files = [
    os.path.join(
        func_dir,
        &quot;sub-04570_task-rest_echo-1_space-scanner_desc-partialPreproc_bold.nii.gz&quot;,
    ),
    os.path.join(
        func_dir,
        &quot;sub-04570_task-rest_echo-2_space-scanner_desc-partialPreproc_bold.nii.gz&quot;,
    ),
    os.path.join(
        func_dir,
        &quot;sub-04570_task-rest_echo-3_space-scanner_desc-partialPreproc_bold.nii.gz&quot;,
    ),
    os.path.join(
        func_dir,
        &quot;sub-04570_task-rest_echo-4_space-scanner_desc-partialPreproc_bold.nii.gz&quot;,
    ),
]
ted_dir = os.path.join(data_path, &quot;tedana&quot;)
ECHO_TIMES = [12, 28, 44, 60]
n_echoes = len(ECHO_TIMES)

pal = sns.color_palette(&quot;cubehelix&quot;, n_echoes)

img = image.index_img(data_files[0], 0)
data = img.get_fdata()
vmax = np.max(data)
idx = np.vstack(np.where(data &gt; 1000))

min_x, min_y, min_z = np.min(idx, axis=1)
max_x, max_y, max_z = np.max(idx, axis=1)

imgs = []
for f in data_files:
    img = image.index_img(f, 0)
    data = img.get_fdata()
    data = data[min_x:max_x, min_y:max_y, min_z:max_z]
    img = nib.Nifti1Image(data, img.affine, img.header)
    imgs.append(img)

# Create binary mask from adaptive mask
adaptive_mask_file = os.path.join(
    ted_dir, &quot;sub-04570_task-rest_space-scanner_desc-adaptiveGoodSignal_mask.nii.gz&quot;
)
mask = image.math_img(&quot;img &gt;= 3&quot;, img=adaptive_mask_file)

# Component parameter estimates
betas_file = os.path.join(
    ted_dir, &quot;sub-04570_task-rest_space-scanner_desc-ICA_components.nii.gz&quot;
)
beta_maps = masking.apply_mask(betas_file, mask)

# Component table
comp_tbl = pd.read_table(
    os.path.join(ted_dir, &quot;sub-04570_task-rest_space-scanner_desc-tedana_metrics.tsv&quot;),
    index_col=&quot;Component&quot;,
)

# Get voxel index for voxel most related to component with highest kappa value
acc_comp_tbl = comp_tbl.loc[comp_tbl[&quot;classification&quot;] == &quot;accepted&quot;]
high_kappa_comp = acc_comp_tbl.sort_values(by=&quot;kappa&quot;, ascending=False).index.values[0]
high_kappa_comp_val = int(high_kappa_comp.split(&quot;_&quot;)[1])
voxel_idx = np.where(
    beta_maps[high_kappa_comp_val, :] == np.max(beta_maps[high_kappa_comp_val, :])
)[0][0]

# Extract the time series for the high-kappa voxel
data = [masking.apply_mask(f, mask) for f in data_files]
ts = [d[:, voxel_idx] for d in data]
ts_1d = np.hstack(ts)

n_trs = ts[0].shape[0]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">26</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="n">n_echoes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ECHO_TIMES</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;cubehelix&quot;</span><span class="p">,</span> <span class="n">n_echoes</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">26</span> <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">index_img</span><span class="p">(</span><span class="n">data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages/nilearn/image/image.py:652,</span> in <span class="ni">index_img</span><span class="nt">(imgs, index)</span>
<span class="g g-Whitespace">    </span><span class="mi">599</span> <span class="k">def</span> <span class="nf">index_img</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">600</span>     <span class="sd">&quot;&quot;&quot;Indexes into a 4D Niimg-like object in the fourth dimension.</span>
<span class="g g-Whitespace">    </span><span class="mi">601</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">602</span><span class="sd">     Common use cases include extracting a 3D image out of `img` or</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">650</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">651</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">652</span>     <span class="n">imgs</span> <span class="o">=</span> <span class="n">check_niimg_4d</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">653</span>     <span class="c1"># duck-type for pandas arrays, and select the &#39;values&#39; attr</span>
<span class="g g-Whitespace">    </span><span class="mi">654</span>     <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;iloc&#39;</span><span class="p">):</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages/nilearn/_utils/niimg_conversions.py:379,</span> in <span class="ni">check_niimg_4d</span><span class="nt">(niimg, return_iterator, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span> <span class="k">def</span> <span class="nf">check_niimg_4d</span><span class="p">(</span><span class="n">niimg</span><span class="p">,</span> <span class="n">return_iterator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">342</span>     <span class="sd">&quot;&quot;&quot;Check that niimg is a proper 4D niimg-like object and load it.</span>
<span class="g g-Whitespace">    </span><span class="mi">343</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">344</span><span class="sd">     Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">377</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">378</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">379</span>     <span class="k">return</span> <span class="n">check_niimg</span><span class="p">(</span><span class="n">niimg</span><span class="p">,</span> <span class="n">ensure_ndim</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">return_iterator</span><span class="o">=</span><span class="n">return_iterator</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span>                        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages/nilearn/_utils/niimg_conversions.py:271,</span> in <span class="ni">check_niimg</span><span class="nt">(niimg, ensure_ndim, atleast_4d, dtype, return_iterator, wildcards)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">271</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File not found: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">niimg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">272</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">niimg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">273</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File not found: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">niimg</span><span class="p">)</span>

<span class="ne">ValueError</span>: File not found: &#39;/home/runner/work/multi-echo-data-analysis/multi-echo-data-analysis/data/multi-echo-data-analysis/data/sub-04570/func/sub-04570_task-rest_echo-1_space-scanner_desc-partialPreproc_bold.nii.gz&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="signal-decays-as-echo-time-increases">
<h2>Signal decays as echo time increases<a class="headerlink" href="#signal-decays-as-echo-time-increases" title="Permalink to this headline">#</a></h2>
<p>To start, let us look at how BOLD signal changes with increasing echo time in real data.
The data we use is a single resting-state run, with echo times of 12, 28, 44, and 60 milliseconds.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.style.use(&quot;dark_background&quot;)

fig, axes = plt.subplots(figsize=(26, 16), nrows=len(data_files))
for i_echo, img in enumerate(imgs):
    te = ECHO_TIMES[i_echo]
    if i_echo == 0:
        data = img.get_fdata()
        vmax = np.max(data)

    plotting.plot_epi(
        img,
        cut_coords=[-15, 0, 15, 30, 45],
        display_mode=&quot;z&quot;,
        annotate=False,
        draw_cross=False,
        axes=axes[i_echo],
        figure=fig,
        vmax=vmax,
        cmap=&quot;gray&quot;,
    )
    axes[i_echo].set_title(&quot;TE={}ms&quot;.format(te), fontsize=20, pad=0)

glue(&quot;fig_brain_decay&quot;, fig, display=False)

# Reset the style
plt.style.use(&quot;default&quot;)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-brain-decay">
<p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">Signal decay in the brain.</span><a class="headerlink" href="#fig-brain-decay" title="Permalink to this image">#</a></p>
</div>
<div class="section" id="echo-specific-data-and-echo-time">
<h3>Echo-specific data and echo time<a class="headerlink" href="#echo-specific-data-and-echo-time" title="Permalink to this headline">#</a></h3>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(figsize=(14, 6))
values = [i[0] for i in ts]
for i_echo in range(n_echoes):
    rep_echo_times = np.ones(n_trs) * ECHO_TIMES[i_echo]
    ax.scatter(rep_echo_times, ts[i_echo], alpha=0.05, color=pal[i_echo])

ax.set_ylabel(&quot;BOLD signal&quot;, fontsize=16)
ax.set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=16)
ax.set_xticks(ECHO_TIMES)
ax.tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
ax.set_xlim(0, 70)
ax.set_ylim(0, 3000)
fig.tight_layout()
glue(&quot;fig_echo_scatter&quot;, fig, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-echo-scatter">
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Scatter plot of voxel’s values by echo time.</span><a class="headerlink" href="#fig-echo-scatter" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="the-signal-itself-changes-with-echo-time-as-well">
<h3>The signal itself changes with echo time as well<a class="headerlink" href="#the-signal-itself-changes-with-echo-time-as-well" title="Permalink to this headline">#</a></h3>
<p>While the overall scale of the signal decreases with echo time, the actual pattern of the signal changes as well.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, axes = plt.subplots(n_echoes, sharex=True, sharey=False, figsize=(14, 6))
for i_echo in range(n_echoes):
    axes[i_echo].plot(ts[i_echo], color=pal[i_echo])
    axes[i_echo].set_ylabel(
        f&quot;{ECHO_TIMES[i_echo]}ms&quot;, rotation=0, va=&quot;center&quot;, ha=&quot;right&quot;, fontsize=14
    )
    axes[i_echo].set_yticks([])
    axes[i_echo].set_xticks([])

axes[-1].set_xlabel(&quot;Time&quot;, fontsize=16)
axes[-1].set_xlim(0, len(ts[i_echo]) - 1)
fig.tight_layout()
glue(&quot;fig_echo_timeseries&quot;, fig, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-echo-timeseries">
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Time series from a voxel for each echo.</span><a class="headerlink" href="#fig-echo-timeseries" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
<div class="section" id="the-impact-of-t-2-and-s-0-fluctuations-on-bold-signal">
<h2>The impact of <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> and <span class="math notranslate nohighlight">\(S_{0}\)</span> fluctuations on BOLD signal<a class="headerlink" href="#the-impact-of-t-2-and-s-0-fluctuations-on-bold-signal" title="Permalink to this headline">#</a></h2>
<p>In this section, we investigate the two factors driving changes in the signal decay pattern: <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> and <span class="math notranslate nohighlight">\(S_{0}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Simulate data
SINGLEECHO_TE = np.array([30])

# For a nice, smooth curve
FULLCURVE_TES = np.arange(0, 101, 1)

n_echoes = len(FULLCURVE_TES)
pal = sns.color_palette(&quot;cubehelix&quot;, 8)
</pre></div>
</div>
</div>
</div>
<div class="section" id="simulate-t-2-and-s-0-fluctuations">
<h3>Simulate <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> and <span class="math notranslate nohighlight">\(S_{0}\)</span> fluctuations<a class="headerlink" href="#simulate-t-2-and-s-0-fluctuations" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Simulate data
# We&#39;ll convolve with HRF just for smoothness
hrf = first_level.spm_hrf(1, oversampling=1)

N_VOLS = 21

SCALING_FRACTION = 0.1  # used to scale standard deviation
MEAN_T2S = 35
MEAN_S0 = 16000

# simulate the T2*/S0 time series
# The original time series will be a random time series from a normal distribution,
# convolved with the HRF
ts = np.random.normal(loc=0, scale=1, size=(N_VOLS + 20,))
ts = signal.convolve(ts, hrf)[20 : N_VOLS + 20]
ts *= SCALING_FRACTION / np.std(ts)
ts -= ts[0]

t2s_ts = (ts * MEAN_T2S) + MEAN_T2S
s0_ts = (ts * MEAN_S0) + MEAN_S0
</pre></div>
</div>
</div>
</div>
<div class="section" id="plot-bold-signal-decay-for-a-standard-single-echo-scan">
<h4>Plot BOLD signal decay for a standard single-echo scan<a class="headerlink" href="#plot-bold-signal-decay-for-a-standard-single-echo-scan" title="Permalink to this headline">#</a></h4>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fullcurve_signal = predict_bold_signal(FULLCURVE_TES, [MEAN_S0], [30])

fig, ax = plt.subplots(figsize=(14, 7.5))
ax.plot(
    FULLCURVE_TES,
    fullcurve_signal[:, 0],
    alpha=0.5,
    color=&quot;black&quot;,
)

ax.set_ylabel(&quot;Recorded BOLD signal&quot;, fontsize=24)
ax.set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
ax.set_ylim(0, np.ceil(np.max(fullcurve_signal) / 1000) * 1000)
ax.set_xlim(0, np.max(FULLCURVE_TES))
ax.tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()
glue(&quot;fig_signal_decay_single-echo&quot;, fig, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-signal-decay-single-echo">
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">BOLD signal decay for a standard single-echo scan</span><a class="headerlink" href="#fig-signal-decay-single-echo" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
<div class="section" id="plot-bold-signal-decay-and-bold-contrast">
<h3>Plot BOLD signal decay and BOLD contrast<a class="headerlink" href="#plot-bold-signal-decay-and-bold-contrast" title="Permalink to this headline">#</a></h3>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fullcurve_signal_active = predict_bold_signal(FULLCURVE_TES, [MEAN_S0], [40])
fullcurve_signal_inactive = predict_bold_signal(FULLCURVE_TES, [MEAN_S0], [20])

fig, ax = plt.subplots(figsize=(14, 7.5))
ax.plot(
    FULLCURVE_TES,
    fullcurve_signal_active[:, 0],
    alpha=0.5,
    color=&quot;red&quot;,
    label=&quot;High Activity&quot;,
)
ax.plot(
    FULLCURVE_TES,
    fullcurve_signal_inactive[:, 0],
    alpha=0.5,
    color=&quot;blue&quot;,
    label=&quot;Low Activity&quot;,
)

ax.set_ylabel(&quot;Recorded BOLD signal&quot;, fontsize=24)
ax.set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
ax.set_ylim(0, np.ceil(np.max(fullcurve_signal) / 1000) * 1000)
ax.set_xlim(0, np.max(FULLCURVE_TES))
ax.legend(fontsize=20)
ax.tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()
glue(&quot;fig_signal_decay_contrast&quot;, fig, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-signal-decay-contrast">
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">BOLD signal decay and BOLD contrast</span><a class="headerlink" href="#fig-signal-decay-contrast" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="plot-single-echo-data-resulting-from-s-0-and-t-2-fluctuations">
<h3>Plot single-echo data resulting from <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations<a class="headerlink" href="#plot-single-echo-data-resulting-from-s-0-and-t-2-fluctuations" title="Permalink to this headline">#</a></h3>
<p>This shows how fMRI data fluctuates over time.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fullcurve_signal = predict_bold_signal(FULLCURVE_TES, s0_ts, t2s_ts)
singleecho_signal = fullcurve_signal[SINGLEECHO_TE, :]

# gif code based on https://www.geeksforgeeks.org/create-an-animated-gif-using-python-matplotlib/
fig, axes = plt.subplots(
    nrows=2, figsize=(14, 10), gridspec_kw={&quot;height_ratios&quot;: [1, 3]}
)

# Set constant params for figure
axes[0].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[0].set_xlabel(&quot;Volume&quot;, fontsize=24)
axes[0].set_xlim(0, N_VOLS - 1)
axes[0].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
axes[1].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[1].set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
axes[1].set_xticks(ECHO_TIMES)
axes[1].set_ylim(0, np.ceil(np.max(fullcurve_signal) / 1000) * 1000)
axes[1].set_xlim(0, np.max(FULLCURVE_TES))
axes[1].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()

ax0_line_plot = axes[0].plot(singleecho_signal[0, :], color=&quot;black&quot;, zorder=0)
ax0_scatter_plot = axes[0].scatter(
    0,
    singleecho_signal[:, 0],
    color=&quot;orange&quot;,
    s=150,
    label=&quot;Single-Echo Signal&quot;,
    zorder=1,
)
ax1_scatter_plot = axes[1].scatter(
    SINGLEECHO_TE,
    singleecho_signal[:, 0],
    color=&quot;orange&quot;,
    s=150,
    alpha=1.0,
    label=&quot;Single-Echo Signal&quot;,
    zorder=1,
)


def AnimationFunction(frame):
    &quot;&quot;&quot;Function takes frame as an input.&quot;&quot;&quot;
    ax0_scatter_plot.set_offsets(
        np.column_stack(
            (
                frame,
                singleecho_signal[:, frame],
            )
        )
    )

    ax1_scatter_plot.set_offsets(
        np.column_stack(
            (
                SINGLEECHO_TE,
                singleecho_signal[:, frame],
            )
        )
    )


anim_created = FuncAnimation(fig, AnimationFunction, frames=N_VOLS, interval=100)
html = display.HTML(anim_created.to_jshtml())
glue(&quot;fig_single-echo&quot;, html, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-single-echo">
<p class="caption"><span class="caption-number">Fig. 6 </span><span class="caption-text">Single-echo data resulting from <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations</span><a class="headerlink" href="#fig-single-echo" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="plot-single-echo-data-and-the-curve-resulting-from-s-0-and-t-2-fluctuations">
<h3>Plot single-echo data and the curve resulting from <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations<a class="headerlink" href="#plot-single-echo-data-and-the-curve-resulting-from-s-0-and-t-2-fluctuations" title="Permalink to this headline">#</a></h3>
<p>This shows how single-echo data is a sample from a signal decay curve.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fullcurve_signal = predict_bold_signal(FULLCURVE_TES, s0_ts, t2s_ts)
singleecho_signal = fullcurve_signal[SINGLEECHO_TE, :]

# gif code based on https://www.geeksforgeeks.org/create-an-animated-gif-using-python-matplotlib/
fig, axes = plt.subplots(
    nrows=2, figsize=(14, 10), gridspec_kw={&quot;height_ratios&quot;: [1, 3]}
)

# Set constant params for figure
axes[0].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[0].set_xlabel(&quot;Volume&quot;, fontsize=24)
axes[0].set_xlim(0, N_VOLS - 1)
axes[0].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
axes[1].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[1].set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
axes[1].set_xticks(ECHO_TIMES)
axes[1].set_ylim(0, np.ceil(np.max(fullcurve_signal) / 1000) * 1000)
axes[1].set_xlim(0, np.max(FULLCURVE_TES))
axes[1].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()

ax0_line_plot = axes[0].plot(singleecho_signal[0, :], color=&quot;black&quot;, zorder=0)
ax0_scatter_plot = axes[0].scatter(
    0,
    singleecho_signal[:, 0],
    color=&quot;orange&quot;,
    s=150,
    label=&quot;Single-Echo Signal&quot;,
    zorder=1,
)
ax1_line_plot = axes[1].plot(
    FULLCURVE_TES,
    fullcurve_signal[:, 0],
    alpha=0.5,
    color=&quot;black&quot;,
    zorder=0,
)[0]
ax1_scatter_plot = axes[1].scatter(
    SINGLEECHO_TE,
    singleecho_signal[:, 0],
    color=&quot;orange&quot;,
    s=150,
    alpha=1.0,
    label=&quot;Single-Echo Signal&quot;,
    zorder=1,
)


def AnimationFunction(frame):
    &quot;&quot;&quot;Function takes frame as an input.&quot;&quot;&quot;
    ax0_scatter_plot.set_offsets(
        np.column_stack(
            (
                frame,
                singleecho_signal[:, frame],
            )
        )
    )

    ax1_line_plot.set_data(
        (
            FULLCURVE_TES,
            fullcurve_signal[:, frame],
        )
    )
    ax1_scatter_plot.set_offsets(
        np.column_stack(
            (
                SINGLEECHO_TE,
                singleecho_signal[:, frame],
            )
        )
    )


anim_created = FuncAnimation(fig, AnimationFunction, frames=N_VOLS, interval=100)
html = display.HTML(anim_created.to_jshtml())
glue(&quot;fig_signal_decay&quot;, html, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-signal-decay">
<p class="caption"><span class="caption-number">Fig. 7 </span><span class="caption-text">Single-echo data and the curve resulting from <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations</span><a class="headerlink" href="#fig-signal-decay" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="plot-single-echo-data-the-curve-and-the-s-0-and-t-2-values-resulting-from-s-0-and-t-2-fluctuations">
<h3>Plot single-echo data, the curve, and the <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> values resulting from <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations<a class="headerlink" href="#plot-single-echo-data-the-curve-and-the-s-0-and-t-2-values-resulting-from-s-0-and-t-2-fluctuations" title="Permalink to this headline">#</a></h3>
<p>This shows how changes in fMRI data can be driven by both S0 and T2* fluctuations.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fullcurve_signal = predict_bold_signal(FULLCURVE_TES, s0_ts, t2s_ts)
singleecho_signal = fullcurve_signal[SINGLEECHO_TE, :]

fig, axes = plt.subplots(
    nrows=2, figsize=(14, 10), gridspec_kw={&quot;height_ratios&quot;: [1, 3]}
)

t2s_value = predict_bold_signal(
    np.array([t2s_ts[0]]), np.array([s0_ts[0]]), np.array([t2s_ts[0]])
)[0]

ax0_line_plot = axes[0].plot(singleecho_signal[0, :], color=&quot;black&quot;, zorder=0)
ax0_scatter_plot = axes[0].scatter(
    0,
    singleecho_signal[:, 0],
    color=&quot;orange&quot;,
    s=150,
    label=&quot;Single-Echo Signal&quot;,
    zorder=1,
)
ax1_line_plot = axes[1].plot(
    FULLCURVE_TES,
    fullcurve_signal[:, 0],
    alpha=0.5,
    color=&quot;black&quot;,
    zorder=0,
)[0]
ax1_scatter_plot = axes[1].scatter(
    SINGLEECHO_TE,
    singleecho_signal[:, 0],
    color=&quot;orange&quot;,
    s=150,
    alpha=1.0,
    label=&quot;Single-Echo Signal&quot;,
    zorder=1,
)
ax1_t2s_scatter_plot = axes[1].scatter(
    t2s_ts[0],
    t2s_value,
    marker=&quot;*&quot;,
    color=&quot;blue&quot;,
    s=500,
    alpha=0.5,
    label=&quot;$T_{2}^{*}$&quot;,
    zorder=1,
)
ax1_s0_scatter_plot = axes[1].scatter(
    0,
    s0_ts[0],
    marker=&quot;*&quot;,
    color=&quot;red&quot;,
    s=500,
    alpha=0.5,
    label=&quot;$S_{0}$&quot;,
    clip_on=False,
    zorder=2,
)

# Set constant params for figure
axes[0].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[0].set_xlabel(&quot;Volume&quot;, fontsize=24)
axes[0].set_xlim(0, N_VOLS - 1)
axes[0].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
axes[1].legend(loc=&quot;upper right&quot;, fontsize=20)
axes[1].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[1].set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
axes[1].set_xticks(ECHO_TIMES)
axes[1].set_ylim(0, np.ceil(np.max(fullcurve_signal) / 1000) * 1000)
axes[1].set_xlim(0, np.max(FULLCURVE_TES))
axes[1].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()


def AnimationFunction(frame):
    &quot;&quot;&quot;Function takes frame as an input.&quot;&quot;&quot;
    t2s_value = predict_bold_signal(
        np.array([t2s_ts[frame]]), np.array([s0_ts[frame]]), np.array([t2s_ts[frame]])
    )[0]

    ax0_scatter_plot.set_offsets(
        np.column_stack(
            (
                frame,
                singleecho_signal[:, frame],
            )
        )
    )

    ax1_line_plot.set_data(
        (
            FULLCURVE_TES,
            fullcurve_signal[:, frame],
        )
    )
    ax1_scatter_plot.set_offsets(
        np.column_stack(
            (
                SINGLEECHO_TE,
                singleecho_signal[:, frame],
            )
        )
    )
    ax1_t2s_scatter_plot.set_offsets(
        np.column_stack(
            (
                t2s_ts[frame],
                t2s_value,
            )
        )
    )
    ax1_s0_scatter_plot.set_offsets(
        np.column_stack(
            (
                0,
                s0_ts[frame],
            )
        )
    )


anim_created = FuncAnimation(fig, AnimationFunction, frames=N_VOLS, interval=100)
html = display.HTML(anim_created.to_jshtml())
glue(&quot;fig_signal_decay2&quot;, html, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-signal-decay2">
<p class="caption"><span class="caption-number">Fig. 8 </span><span class="caption-text">Single-echo data, the curve, and the <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> values resulting from <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations</span><a class="headerlink" href="#fig-signal-decay2" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="plot-s-0-and-t-2-fluctuations">
<h3>Plot <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations<a class="headerlink" href="#plot-s-0-and-t-2-fluctuations" title="Permalink to this headline">#</a></h3>
<p>This shows how fluctuations in S0 and T2* produce different patterns in the full signal decay curves.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>s0based_fullcurve_signal = predict_bold_signal(
    FULLCURVE_TES, s0_ts, np.full(N_VOLS, MEAN_T2S)
)
t2sbased_fullcurve_signal = predict_bold_signal(
    FULLCURVE_TES, np.full(N_VOLS, MEAN_S0), t2s_ts
)
unperturbed_fullcurve_signal = np.mean(
    (s0based_fullcurve_signal[:, 0], t2sbased_fullcurve_signal[:, 0]),
    axis=0,
)

fig, axes = plt.subplots(
    nrows=2, figsize=(14, 10), gridspec_kw={&quot;height_ratios&quot;: [1, 3]}
)

t2s_value = predict_bold_signal(
    np.array([t2s_ts[0]]), np.array([s0_ts[0]]), np.array([t2s_ts[0]])
)[0]

ax0_line_plot = axes[0].plot(ts, color=&quot;black&quot;, zorder=0)
ax0_scatter_plot = axes[0].scatter(
    0,
    ts[0],
    color=&quot;purple&quot;,
    s=150,
    label=&quot;Single-Echo Signal&quot;,
    zorder=1,
)
ax1_orig_line_plot = axes[1].plot(
    FULLCURVE_TES,
    unperturbed_fullcurve_signal,
    alpha=0.5,
    color=&quot;black&quot;,
    label=&quot;Original Average Decay Curve&quot;,
    zorder=-1,
)[0]
ax1_s0_line_plot = axes[1].plot(
    FULLCURVE_TES,
    s0based_fullcurve_signal[:, 0],
    alpha=0.5,
    color=&quot;red&quot;,
    label=&quot;$S_0$-Driven Decay Curve&quot;,
)[0]
ax1_t2s_line_plot = axes[1].plot(
    FULLCURVE_TES,
    t2sbased_fullcurve_signal[:, 0],
    alpha=0.5,
    color=&quot;blue&quot;,
    label=&quot;$T_{2}^{*}$-Driven Decay Curve&quot;,
)[0]

# Set constant params for figure
axes[0].set_ylabel(&quot;$S_0$/$T_{2}^{*}$&quot;, fontsize=24)
axes[0].set_xlabel(&quot;Volume&quot;, fontsize=24)
axes[0].set_xlim(0, N_VOLS - 1)
axes[0].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
axes[1].legend(loc=&quot;upper right&quot;, fontsize=20)
axes[1].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[1].set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
axes[1].set_xticks(ECHO_TIMES)
axes[1].set_ylim(0, np.ceil(np.max(s0based_fullcurve_signal) / 1000) * 1000)
axes[1].set_xlim(0, np.max(FULLCURVE_TES))
axes[1].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()


def AnimationFunction(frame):
    &quot;&quot;&quot;Function takes frame as an input.&quot;&quot;&quot;
    ax0_scatter_plot.set_offsets(
        np.column_stack(
            (
                frame,
                ts[frame],
            )
        )
    )

    ax1_t2s_line_plot.set_data(
        (
            FULLCURVE_TES,
            t2sbased_fullcurve_signal[:, frame],
        )
    )
    ax1_s0_line_plot.set_data(
        (
            FULLCURVE_TES,
            s0based_fullcurve_signal[:, frame],
        )
    )


anim_created = FuncAnimation(fig, AnimationFunction, frames=N_VOLS, interval=100)
html = display.HTML(anim_created.to_jshtml())
glue(&quot;fig_signal_decay3&quot;, html, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-signal-decay3">
<p class="caption"><span class="caption-number">Fig. 9 </span><span class="caption-text"><span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations</span><a class="headerlink" href="#fig-signal-decay3" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="plot-s-0-and-t-2-fluctuations-and-resulting-single-echo-data">
<h3>Plot <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations and resulting single-echo data<a class="headerlink" href="#plot-s-0-and-t-2-fluctuations-and-resulting-single-echo-data" title="Permalink to this headline">#</a></h3>
<p>This shows how single-echo data, on its own, cannot distinguish between S0 and T2* fluctuations.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>s0based_fullcurve_signal = predict_bold_signal(
    FULLCURVE_TES, s0_ts, np.full(N_VOLS, MEAN_T2S)
)
t2sbased_fullcurve_signal = predict_bold_signal(
    FULLCURVE_TES, np.full(N_VOLS, MEAN_S0), t2s_ts
)
s0based_singleecho_signal = s0based_fullcurve_signal[SINGLEECHO_TE, :]
t2sbased_singleecho_signal = t2sbased_fullcurve_signal[SINGLEECHO_TE, :]

fig, axes = plt.subplots(
    nrows=2, figsize=(14, 10), gridspec_kw={&quot;height_ratios&quot;: [1, 3]}
)

ax0_line_plot = axes[0].plot(ts, color=&quot;black&quot;, zorder=0)
ax0_scatter_plot = axes[0].scatter(
    0,
    ts[0],
    color=&quot;purple&quot;,
    s=150,
    zorder=1,
)
ax1_s0_line_plot = axes[1].plot(
    FULLCURVE_TES,
    s0based_fullcurve_signal[:, 0],
    color=&quot;red&quot;,
    alpha=0.5,
    label=&quot;$S_0$-Driven Decay Curve&quot;,
    zorder=0,
)[0]
ax1_t2s_line_plot = axes[1].plot(
    FULLCURVE_TES,
    t2sbased_fullcurve_signal[:, 0],
    color=&quot;blue&quot;,
    alpha=0.5,
    label=&quot;$T_{2}^{*}$-Driven Decay Curve&quot;,
    zorder=1,
)[0]
ax1_s0_scatter_plot = axes[1].scatter(
    SINGLEECHO_TE,
    s0based_singleecho_signal[:, 0],
    color=&quot;red&quot;,
    s=150,
    alpha=1.0,
    label=&quot;$S_0$-Driven Single-Echo Signal&quot;,
    zorder=2,
)
ax1_t2s_scatter_plot = axes[1].scatter(
    SINGLEECHO_TE,
    t2sbased_singleecho_signal[:, 0],
    color=&quot;blue&quot;,
    s=150,
    alpha=1.0,
    label=&quot;$T_{2}^{*}$-Driven Single-Echo Signal&quot;,
    zorder=3,
)

# Set constant params for figure
axes[0].set_ylabel(&quot;$S_0$/$T_{2}^{*}$&quot;, fontsize=24)
axes[0].set_xlabel(&quot;Volume&quot;, fontsize=24)
axes[0].set_xlim(0, N_VOLS - 1)
axes[0].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
axes[1].legend(loc=&quot;upper right&quot;, fontsize=20)
axes[1].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[1].set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
axes[1].set_xticks(ECHO_TIMES)
axes[1].set_ylim(0, np.ceil(np.max(s0based_fullcurve_signal) / 1000) * 1000)
axes[1].set_xlim(0, np.max(FULLCURVE_TES))
axes[1].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()


def AnimationFunction(frame):
    &quot;&quot;&quot;Function takes frame as an input.&quot;&quot;&quot;
    ax0_scatter_plot.set_offsets(
        np.column_stack(
            (
                frame,
                ts[frame],
            )
        )
    )

    ax1_s0_line_plot.set_data(
        (
            FULLCURVE_TES,
            s0based_fullcurve_signal[:, frame],
        )
    )
    ax1_t2s_line_plot.set_data(
        (
            FULLCURVE_TES,
            t2sbased_fullcurve_signal[:, frame],
        )
    )
    ax1_s0_scatter_plot.set_offsets(
        np.column_stack(
            (
                SINGLEECHO_TE,
                s0based_singleecho_signal[:, frame],
            )
        )
    )
    ax1_t2s_scatter_plot.set_offsets(
        np.column_stack(
            (
                SINGLEECHO_TE,
                t2sbased_singleecho_signal[:, frame],
            )
        )
    )


anim_created = FuncAnimation(fig, AnimationFunction, frames=N_VOLS, interval=100)
html = display.HTML(anim_created.to_jshtml())
glue(&quot;fig_signal_decay4&quot;, html, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-signal-decay4">
<p class="caption"><span class="caption-number">Fig. 10 </span><span class="caption-text"><span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations and resulting single-echo data</span><a class="headerlink" href="#fig-signal-decay4" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="plot-s-0-and-t-2-fluctuations-and-resulting-multi-echo-data">
<h3>Plot <span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations and resulting multi-echo data<a class="headerlink" href="#plot-s-0-and-t-2-fluctuations-and-resulting-multi-echo-data" title="Permalink to this headline">#</a></h3>
<p>This shows how S0 and T2* fluctuations produce different patterns in multi-echo data.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>s0based_fullcurve_signal = predict_bold_signal(
    FULLCURVE_TES, s0_ts, np.full(N_VOLS, MEAN_T2S)
)
t2sbased_fullcurve_signal = predict_bold_signal(
    FULLCURVE_TES, np.full(N_VOLS, MEAN_S0), t2s_ts
)
s0based_multiecho_signal = s0based_fullcurve_signal[ECHO_TIMES, :]
t2sbased_multiecho_signal = t2sbased_fullcurve_signal[ECHO_TIMES, :]

fig, axes = plt.subplots(
    nrows=2, figsize=(14, 10), gridspec_kw={&quot;height_ratios&quot;: [1, 3]}
)

ax0_line_plot = axes[0].plot(
    ts,
    color=&quot;black&quot;,
    zorder=0,
)[0]
ax0_scatter_plot = axes[0].scatter(
    0,
    ts[0],
    color=&quot;purple&quot;,
    s=150,
    zorder=1,
)
ax1_s0_line_plot = axes[1].plot(
    FULLCURVE_TES,
    s0based_fullcurve_signal[:, 0],
    color=&quot;red&quot;,
    alpha=0.5,
    label=&quot;$S_0$-Driven Decay Curve&quot;,
    zorder=0,
)[0]
ax1_t2s_line_plot = axes[1].plot(
    FULLCURVE_TES,
    t2sbased_fullcurve_signal[:, 0],
    color=&quot;blue&quot;,
    alpha=0.5,
    label=&quot;$T_{2}^{*}$-Driven Decay Curve&quot;,
    zorder=1,
)[0]
ax1_s0_scatter_plot = axes[1].scatter(
    ECHO_TIMES,
    s0based_multiecho_signal[:, 0],
    color=&quot;red&quot;,
    s=150,
    alpha=1.0,
    label=&quot;$S_0$-Driven Multi-Echo Signal&quot;,
    zorder=2,
)
ax1_t2s_scatter_plot = axes[1].scatter(
    ECHO_TIMES,
    t2sbased_multiecho_signal[:, 0],
    color=&quot;blue&quot;,
    s=150,
    alpha=1.0,
    label=&quot;$T_{2}^{*}$-Driven Multi-Echo Signal&quot;,
    zorder=3,
)

axes[0].set_ylabel(&quot;$S_0$/$T_{2}^{*}$&quot;, fontsize=24)
axes[0].set_xlabel(&quot;Volume&quot;, fontsize=24)
axes[0].set_xlim(0, N_VOLS - 1)
axes[0].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
axes[1].legend(loc=&quot;upper right&quot;, fontsize=20)
axes[1].set_ylabel(&quot;Signal&quot;, fontsize=24)
axes[1].set_xlabel(&quot;Echo Time (ms)&quot;, fontsize=24)
axes[1].set_xticks(ECHO_TIMES)
axes[1].set_ylim(0, np.ceil(np.max(s0based_fullcurve_signal) / 1000) * 1000)
axes[1].set_xlim(0, np.max(FULLCURVE_TES))
axes[1].tick_params(axis=&quot;both&quot;, which=&quot;major&quot;, labelsize=14)
fig.tight_layout()


def AnimationFunction(frame):
    &quot;&quot;&quot;Function takes frame as an input.&quot;&quot;&quot;
    ax0_scatter_plot.set_offsets(
        np.column_stack(
            (
                frame,
                ts[frame],
            )
        )
    )

    ax1_s0_line_plot.set_data(
        (
            FULLCURVE_TES,
            s0based_fullcurve_signal[:, frame],
        )
    )
    ax1_t2s_line_plot.set_data(
        (
            FULLCURVE_TES,
            t2sbased_fullcurve_signal[:, frame],
        )
    )
    ax1_s0_scatter_plot.set_offsets(
        np.column_stack(
            (
                ECHO_TIMES,
                s0based_multiecho_signal[:, frame],
            )
        )
    )
    ax1_t2s_scatter_plot.set_offsets(
        np.column_stack(
            (
                ECHO_TIMES,
                t2sbased_multiecho_signal[:, frame],
            )
        )
    )


anim_created = FuncAnimation(fig, AnimationFunction, frames=N_VOLS, interval=100)
html = display.HTML(anim_created.to_jshtml())
glue(&quot;fig_signal_decay5&quot;, html, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-signal-decay5">
<p class="caption"><span class="caption-number">Fig. 11 </span><span class="caption-text"><span class="math notranslate nohighlight">\(S_{0}\)</span> and <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> fluctuations and resulting multi-echo data</span><a class="headerlink" href="#fig-signal-decay5" title="Permalink to this image">#</a></p>
</div>
<div class="section" id="plot-t-2-against-bold-signal-from-single-echo-data-te-30ms">
<h4>Plot <span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> against BOLD signal from single-echo data (TE=30ms)<a class="headerlink" href="#plot-t-2-against-bold-signal-from-single-echo-data-te-30ms" title="Permalink to this headline">#</a></h4>
<p>When the BOLD signal is driven entirely by T2* fluctuations,
the BOLD signal is very similar to a scaled version of those T2* fluctuations, but there are small differences.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(figsize=(16, 4))

scalar = np.linalg.lstsq(
    t2s_ts[:, None], t2sbased_fullcurve_signal[SINGLEECHO_TE[0], :], rcond=None
)[0]
ax.plot(
    t2sbased_fullcurve_signal[SINGLEECHO_TE[0], :],
    color=&quot;orange&quot;,
    label=f&quot;BOLD signal (TE={SINGLEECHO_TE[0]}ms)&quot;,
)
ax.plot(
    t2s_ts * scalar,
    label=&quot;$T_{2}^{*}$ (scaled to signal)&quot;,
    linestyle=&quot;--&quot;,
)
ax.set_xlim(0, N_VOLS - 1)
leg = ax.legend()
glue(&quot;fig_t2s_bold_single-echo&quot;, fig, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-t2s-bold-single-echo">
<p class="caption"><span class="caption-number">Fig. 12 </span><span class="caption-text"><span class="math notranslate nohighlight">\(T_{2}^{*}\)</span> against BOLD signal from single-echo data (TE=30ms)</span><a class="headerlink" href="#fig-t2s-bold-single-echo" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="plot-s-0-against-bold-signal-from-single-echo-data-te-30ms">
<h4>Plot <span class="math notranslate nohighlight">\(S_{0}\)</span> against BOLD signal from single-echo data (TE=30ms)<a class="headerlink" href="#plot-s-0-against-bold-signal-from-single-echo-data-te-30ms" title="Permalink to this headline">#</a></h4>
<p>When the BOLD signal is driven entirely by S0 fluctuations, the BOLD signal ends up being a scaled version of the S0 fluctuations.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(figsize=(16, 4))

scalar = np.linalg.lstsq(
    s0_ts[:, None], s0based_fullcurve_signal[SINGLEECHO_TE[0], :], rcond=None
)[0]
ax.plot(
    s0based_fullcurve_signal[SINGLEECHO_TE[0], :],
    color=&quot;orange&quot;,
    label=f&quot;BOLD signal (TE={SINGLEECHO_TE[0]}ms)&quot;,
)
ax.plot(
    s0_ts * scalar,
    label=&quot;S0 (scaled to signal)&quot;,
    linestyle=&quot;--&quot;,
)
ax.set_xlim(0, N_VOLS - 1)
leg = ax.legend()
glue(&quot;fig_s0_bold_single-echo&quot;, fig, display=False)
</pre></div>
</div>
</div>
</div>
<div class="figure align-center" id="fig-s0-bold-single-echo">
<p class="caption"><span class="caption-number">Fig. 13 </span><span class="caption-text"><span class="math notranslate nohighlight">\(S_{0}\)</span> against BOLD signal from single-echo data (TE=30ms)</span><a class="headerlink" href="#fig-s0-bold-single-echo" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="fMRI_Sequences.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Multi-Echo fMRI Sequences</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="TE_Dependence.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">BOLD, non-BOLD, and TE-dependence with tedana</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The tedana community<br/>
  
      &copy; Copyright 2021.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>